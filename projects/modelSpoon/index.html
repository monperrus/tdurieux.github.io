<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spoon Model</title>
    <script src="data/model.js"></script>

    <link rel="stylesheet" type="text/css" href="http://www.jointjs.com/downloads/joint.min.css">
    <script src="http://www.jointjs.com/js/vendor/jquery/jquery.min.js"></script>
    <script src="http://www.jointjs.com/js/vendor/lodash/lodash.min.js"></script>
    <script src="http://www.jointjs.com/js/vendor/backbone/backbone-min.js"></script>
    <script src="http://www.jointjs.com/downloads/joint.min.js"></script>
    <script src="http://www.jointjs.com/downloads/joint.shapes.logic.min.js"></script>
</head>
<body>
    <div id="model"></div>

    <script>
        var ClickableView = joint.dia.ElementView.extend({
            pointerdown: function () {
                this._click = true;
                joint.dia.ElementView.prototype.pointerdown.apply(this, arguments);
            },
            pointermove: function () {
                this._click = false;
                joint.dia.ElementView.prototype.pointermove.apply(this, arguments);
            },
            pointerup: function (evt, x, y) {
                if (this._click) {
                    this.notify('cell:click', evt, x, y);
                } else {
                    joint.dia.ElementView.prototype.pointerup.apply(this, arguments);
                }
            }
        });

        var graph = new joint.dia.Graph();

        var paper = new joint.dia.Paper({
            el: $('#model'),
            width: 5000,
            height: 800,
            gridSize: 10,
            model: graph,
            elementView: ClickableView
            //interactive: false
        });

        var uml = joint.shapes.uml;

        //console.log(spoonModel);
        var classes = {};
        var relations = [];

        var x = 0;
        var y = 0;
        var count = 0;

        var getClassLevel = function (cl) {
            if(!cl.interfaces || cl.interfaces.length == 0) {
                return 0;
            }
            var level = 0;
            for(var i = 0; i < cl.interfaces.length; i++) {
                var inter = cl.interfaces[i];
                if(!spoonModel[inter]) {
                    continue;
                }
                if(!spoonModel[inter].children) {
                    spoonModel[inter].children = [];
                }
                spoonModel[inter].children.push(cl);
                level = Math.max(getClassLevel(spoonModel[inter]) + 1, level);
            }
            return level;
        };
        var levels = {};
        var height = 40;
        var width = 120;
        _.each(spoonModel, function(c) {
            var level = getClassLevel(c);
            if (!levels[level]) {
                levels[level] = [];
            }
            levels[level].push(c);
        });

        var max = 0;
        _.each(levels, function(c) {
            max = Math.max(c.length, max);
        });
        var levels = {};

        var values = _.map(spoonModel, function(value) { return value });
        values.sort(function (a, b) {
            if(!a.children && !b.children) {
                return b.interfaces.length - a.interfaces.length;
            }
            if(!a.children) {
                return 99;
            }
            if(!b.children) {
                return -99;
            }
            if(b.children.length == a.children.length) {
                if(b.interfaces == null || a.interfaces == null) {
                    return 0;
                }
                return b.interfaces.length - a.interfaces.length;
            }
            return b.children.length - a.children.length;
        });

        _.each(values, function(c) {
            var level = getClassLevel(c);
            count ++;
            if (!levels[level]) {
                levels[level] = [];
            }
            classes[c.package + "." + c.name] = (new uml.Class({
                position: { x: levels[level].length * (width + 10), y: level*(height + 50) },
                size: { width: width, height: height },
                name: c.name,
                package: c.package,
                attrs: {
                    '.uml-class-name-rect': {
                        fill: 'white',
                        stroke: '#DDD',
                        'stroke-width': 1
                    },
                    '.uml-class-attrs-rect, .uml-class-methods-rect': {
                        fill: '#fff',
                        stroke: '#DDD',
                        'stroke-width': 1
                    }
                }
                //methods: methods
            }));
            levels[level].push(c);
        });


        _.each(spoonModel, function(c, i) {
            _.each(c.interfaces, function(m) {
                if (classes[m]) {
                    if(!classes[i].sourceRelations) {
                        classes[i].sourceRelations = [];
                    }
                    if(!classes[m].targetRelations) {
                        classes[m].targetRelations = [];
                    }
                    var relation = new uml.Generalization({
                        source: {id: classes[i].id},
                        target: {id: classes[m].id},
                        attrs: {
                            '.connection': {
                                stroke: '#DDD'
                            },
                            '.marker-source': { fill: 'none', stroke: '#DDD'},
                            '.marker-target': { fill: 'none', stroke: '#DDD', d: 'M 10 0 L 0 5 L 10 10 z' }
                        }
                    });
                    classes[i].sourceRelations.push(relation);
                    classes[m].targetRelations.push(relation);
                    relations.push(relation);
                }
            });
        });


        _.each(classes, function(c) { graph.addCell(c); });
        _.each(relations, function(r) { graph.addCell(r); });

        paper.$(".link").css('pointer-events', 'none');

        var changeColor = function (m, color, zindex) {
            var current = classes[m.package + "." + m.name];
            current.attr({
                '.uml-class-name-rect, .uml-class-attrs-rect, .uml-class-methods-rect': {
                    stroke: color
                }
            });
            current.toFront(zindex);
            _.each(current.sourceRelations, function (r) {
                r.attr({
                    '.connection': {
                        stroke: color,
                    },
                    '.marker-source': { stroke: color},
                    '.marker-target': { stroke: color}
                });
                r.toFront(zindex);
            });
            _.each(m.interfaces, function(i) {
                if(spoonModel[i]) {
                    changeColor(spoonModel[i], color, zindex);
                }
            });
        };

        paper.on('cell:mouseout', function(cell) {
            var attrs = cell.model.attributes;
            if(attrs.source) {
                return;
            }
            var model = spoonModel[attrs.package + "." + attrs.name];
            changeColor(model, "#DDD", 0);
            //cell.model.set("size", {width: width, height: height});
            //cell.model.set("methods", []);
        });

        paper.on('cell:mouseover', function(cell) {
            var attrs = cell.model.attributes;
            if(attrs.source) {
                return;
            }
            var model = spoonModel[attrs.package + "." + attrs.name];
            var methods = [];
            /*_.each(model.methods, function(m) {
                var params = [];
                _.each(m.parameters, function(p) {
                    if(spoonModel[p.type]) {
                        params.push(spoonModel[p.type].name);
                    } else {
                        params.push(p.type);
                    }
                });
                var output = m.return;
                if(spoonModel[m.return]) {
                    output = (spoonModel[m.return].name);
                }
                methods.push(m.name + "(" + params.join(", ") + "): " + output);
            });*/
            //cell.model.set("size", {width: 300, height: 150});
            //cell.model.set("methods", methods);

            changeColor(model, "#000", 99);
        });
    </script>
</body>
</html>